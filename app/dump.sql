select SESSION_ID,
to_number(nvl(ECHI_CALL_ID,-7777)) as ECHI_CALL_ID,
to_date(CALL_DATE,'YYYY-MM-DD') AS CALL_START_DATE,
TO_TIMESTAMP(CALL_START_TIME,'YYYY-MM-DD HH24:MI:SS') CALL_START_TIME,
CASE when call_type in ('Transferred', 'Internal','Outbound','Not defined') 
THEN ECHI_CALL_ID||'|'||SUBSTR(TO_CHAR(TO_TIMESTAMP(CALL_START_TIME,'YYYY-MM-DD HH24:MI:SS'),'DDMMYYYYHH24MiSS'),9,6)
ELSE session_id end AS EVENT_NUM,
case when call_type='Inbound' then TO_NUMBER(echi_call_id) end AS TRANSFER_EVENT_NUM,
NVL(call_type,'Inbound') AS CALL_TYPE,
TO_NUMBER(CASE WHEN TRANSFERRED_VDN='null' then '0' else TRANSFERRED_VDN end) TRANSFERRED_VDN,
CASE WHEN CALL_TYPE='Outbound' AND LENGTH(TRANSFERRED_VDN)=8
THEN '974'||TRANSFERRED_VDN
WHEN CALL_TYPE='Outbound' AND LENGTH(TRANSFERRED_VDN)=7
THEN '9747'||TRANSFERRED_VDN
ELSE CASE WHEN LENGTH(MSISDN)=8 THEN '974' WHEN LENGTH(MSISDN)=7 
THEN '9747'END||MSISDN END AS SERVED_NUM,
CASE WHEN CALL_TYPE='Outbound' THEN TO_NUMBER(MSISDN)
ELSE TO_NUMBER(CASE WHEN TRANSFERRED_VDN='null' then '0' else TRANSFERRED_VDN end) END AS AGENT_EXT_NUM,
QUEUE_TIME,
UPPER(SUBSTR(agent_name, 1, 2)) AS AGENT_LOCATION_CD,
NVL(call_status,'Unknown') AS CALL_STATUS,
TO_NUMBER(CALLED_IVR) AS CALLED_IVR_NUM,
HLP.DIAL_PATTERN AS IVR_DIAL_PATTERN,
NVL(HLP.LOB,'Unknown') AS IVR_LOB,
TO_NUMBER(AGENT_ID) agent_id,
UPPER(SUBSTR(agent_name, 4)) AS AGENT_NAME,
case when
(case when NVL(disconnect_origin,'Unknown') = 'null' then 'Unknown' else NVL(disconnect_origin,'Unknown') end) <> 'Unknown'
then concat('IVRCALLSTS|',disconnect_origin) else 'Unknown' end
AS DISCONNECT_ORIGIN,
MENU_TRAVERSAL,
TO_TIMESTAMP(CALL_END_TIME,'YYYY-MM-DD HH24:MI:SS') CALL_END_TIME,
TIME_SPENT_WITH_AGENT,
'IVR' AS SOURCE_SYSTEM_CD,
to_date(substr(EDW_FILENAME,-12,8),'YY-MM-DD') as valid_From_dt 
FROM sp_landing.L_IVR_CDR IVR
LEFT JOIN sp_hlp.HLP_IVR_SERVICE HLP ON to_number(nvl(IVR.CALLED_IVR,'0'))=HLP.DNIS
WHERE (ECHI_CALL_ID IS NOT NULL OR SESSION_ID IS NOT NULL) 
--AND to_date(substr(EDW_FILENAME,-12,8),'YY-MM-DD') = to_date('#EXECUTION_DATE#','YYYY-MM-DD')


SELECT ECHI_CALL_ID 
FROM sp_landing.L_IVR_CDR 
WHERE REGEXP_LIKE(ECHI_CALL_ID, '[^0-9]') AND ECHI_CALL_ID IS NOT NULL;


SELECT MSISDN 
FROM sp_landing.L_IVR_CDR 
WHERE REGEXP_LIKE(MSISDN, '[^0-9]')-- AND MSISDN IS NOT NULL;

SELECT TRANSFERRED_VDN 
FROM sp_landing.L_IVR_CDR 
WHERE REGEXP_LIKE(TRANSFERRED_VDN, '[^0-9]') AND TRANSFERRED_VDN IS NOT NULL;
